<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Geographic Data Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='map.css') }}">
</head>
<body>
<div id="map" >
    <div id = "data-controls">
        <form id="form" class="flex-column">
            <!-- Dropdown menu -->
            <select id="dataColumn" class="form-item" onchange="displaySelectedDataColumn()">
                {% for column in numerical_attributes %}
                <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>

            <!-- Range slider for dataColumn values -->
            <div id="slider"></div>
            <div id="slider-inputs">
                <input id="min-range" type="number" oninput="updateRange()">    <!-- oninput is triggered when the value changes -->
                <input id="max-range" type="number" oninput="updateRange()">    <!-- oninput is triggered when the value changes -->
            </div>
            <!-- Dropdown menu for selecting number of ranges -->
            <label for="numRanges" id="numRanges-label" >Number of ranges (R.), default quantiles: </label>
            <select id="numRanges">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>

            <!-- Form for setting ranges and colors -->
            <div id="rangeForm"> <!-- because nested form tag is not present in DOM -->
                <div id="rangeInputs"></div>
            </div>


        </form>
    </div>

</div>


<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<!--<script src="{{ url_for('static', filename='leaflet-src.js') }}"></script>-->
<script src="{{ url_for('static', filename='layers.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.js"></script>
<script src="{{ url_for('static', filename='nouislider.js') }}"></script>

<script>
    const data = JSON.parse({{ data|tojson }});     // data is a jinja variable
    const ranges = JSON.parse({{ quantile_ranges|tojson }});

    // Add markers to map
    var markers = [];
    data.forEach(function (point) {
        // Create marker
        var marker = L.marker([point.LATITUDE, point.LONGITUDE], {
                icon: L.divIcon({
                    className: 'custom-marker'
                })
            }
        ).addTo(map);
        markers.push(marker);

        // Set marker properties
        marker.feature = {
            properties: point
        };
    });

    // Initialize range slider
    var slider = document.getElementById('slider');
    var dataColumn = document.getElementById('dataColumn').value;
    var values = data.map(function (point) {
        return point[dataColumn];
    });
    var min = Math.min.apply(Math, values);
    var max = Math.max.apply(Math, values);
    noUiSlider.create(slider, {
        start: [min, max],
        range: {
            'min': min,
            'max': max
        },
        connect: true,
    });

    // Update input numbers with range values
    document.getElementById('min-range').value = min;
    document.getElementById('max-range').value = max;


    // Update map with dataColumn values
    function displaySelectedDataColumn() {
        // Get selected dataColumn and values
        dataColumn = document.getElementById('dataColumn').value;
        values = data.map(function (point) {
            return point[dataColumn];
        });

        // Update range for noUiSlider
        min = Math.min.apply(Math, values);
        max = Math.max.apply(Math, values);
        slider.noUiSlider.updateOptions({
            start: [min, max],
            range: {
                'min': min,
                'max': max
            }
        });
        // Update input numbers with range values
        document.getElementById('min-range').value = min;
        document.getElementById('max-range').value = max;

        updateMarkersVisibility();
        // Update class ranges
        numRangesChanged(document.getElementById('numRanges').value)
    }

    // Update marker visibility based on dataColumn values and range slider values
    function updateMarkersVisibility() {
        var range = slider.noUiSlider.get();
        min = range[0];
        max = range[1];
        markers.forEach(function (marker) {
            var value = marker.feature.properties[dataColumn];
            marker.setOpacity((value >= min && value <= max) ? 1 : 0);
        });
    }

    // Update range slider with input field values
    function updateRange() {
        min = document.getElementById('min-range').value;
        max = document.getElementById('max-range').value;
        slider.noUiSlider.set([min, max]);
        updateMarkersVisibility()             // Update marker visibility
    }
    // Set up event listeners for range slider and input fields
    slider.noUiSlider.on('slide', function(values) {
        updateMarkersVisibility();        // Update marker visibility
        document.getElementById('min-range').value = values[0];
        document.getElementById('max-range').value = values[1];
    });
    document.getElementById('min-range').addEventListener('change', updateRange);   // Update range slider with input field values
    document.getElementById('max-range').addEventListener('change', updateRange);   // Update range slider with input field values






    function numRangesChanged(numRanges) {
        // Clear the current range inputs
        document.getElementById('rangeInputs').innerHTML = '';

        const palette = ['#003c00', '#005a00', '#007800', '#857800', '#c87600',
                        '#ff7600', '#ff8181', '#ffb2ff', '#ffffff' ];

        // Generate a list of colors from the palette
        const colors = [];
        if (numRanges == 1) {
            colors.push('#dc143c');
        } else {
            for (let i = 0; i < numRanges; i++) {
                // the last -1 because length starts at 1 and index at 0
                colors[i] = palette[Math.floor(i / (numRanges-1) * (palette.length - 1))];
            }
        }


            // Add inputs for each range
            for (let i = 0; i < numRanges; i++) {
                // Create a div for the range input
                const rangeDiv = document.createElement('div');
                rangeDiv.className = 'class-inputs';

                // Create a label for the range input
                const rangeLabel = document.createElement('label');
                rangeLabel.innerHTML = 'R. ' + (i + 1) + '. > ';
                rangeDiv.appendChild(rangeLabel);

                // Create a number input for the range
                const rangeInput = document.createElement('input');
                rangeInput.type = 'number';
                rangeInput.name = 'range' + (i + 1);
                rangeInput.value = ranges[dataColumn][numRanges][i];
                rangeDiv.appendChild(rangeInput);

                // Create a color input for the range
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.name = 'color' + (i + 1);
                colorInput.value = colors[i];
                rangeDiv.appendChild(colorInput);

                // Create a checkbox to toggle the visibility of the range
                const visibilityCheckbox = document.createElement('input');
                visibilityCheckbox.type = 'checkbox';
                visibilityCheckbox.name = 'visibility' + (i + 1);
                visibilityCheckbox.checked = true;  // default to checked
                rangeDiv.appendChild(visibilityCheckbox);

                // Add the range input div to the page
                document.getElementById('rangeInputs').appendChild(rangeDiv);
            }
        updateMarkerColors();
        }

    function updateMarkerColors() {
        // Get the selected number of ranges
        const numRanges = document.getElementById('numRanges').value;

        // Update the ranges with the input values
        for (let i = 0; i < numRanges; i++) {    // for each range
            const rangeInput = document.querySelector('input[name="range' + (i + 1) + '"]');
            ranges[dataColumn][numRanges][i] = rangeInput.value;
        }

        // Get the colors and visibility for each range
        const colors = {};
        const visibility = {};
        for (let i = 0; i < numRanges; i++) {
            const colorInput = document.querySelector('input[name="color' + (i + 1) + '"]');
            colors[i] = colorInput.value;

            const visibilityCheckbox = document.querySelector('input[name="visibility' + (i + 1) + '"]');
            visibility[i] = visibilityCheckbox.checked;
        }

        // Update the marker colors based on the data value and ranges
        markers.forEach(function (marker) {
            const value = marker.feature.properties[dataColumn];
            for (let i = 0; i < numRanges; i++) {    // >= and <= are used to include the max value in the last range
                if (value >= ranges[dataColumn][numRanges][i] && value <= ranges[dataColumn][numRanges][i + 1]) {
                    marker._icon.style.backgroundColor = colors[i];     // set marker's colour to range colour
                    marker._icon.style.opacity = visibility[i] ? 1 : 0;   // set marker's opacity to range visibility
                }
            }
        });
    }


    // Wait for the document to be fully loaded before setting up the event listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Handle changes to the number of ranges dropdown
        document.getElementById('numRanges').addEventListener('change', function () {
            numRangesChanged(this.value);
        });
        // Initialize the range inputs with 1 range
        numRangesChanged(1);

        // Handle changes to the range inputs
        document.getElementById('rangeForm').addEventListener('change', updateMarkerColors);

    });

</script>

{# redundent #}

</body>
</html>
